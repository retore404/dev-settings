# APIレスポンスガイドライン

## このドキュメントについて

このドキュメントは，APIがどのような場合にどのようなレスポンスをすべきかを示すガイドラインである．
本アプリの開発においては以下の考え方に従いAPIの設計を行うこと．

## 基本方針

- **HTTPレスポンスステータスコードに忠実に**
  - HTTPレスポンスステータスコード（RFC 9110）の定義に忠実に従うことを原則とする．
  - 従って，"エラー発生時にステータスコード:200でレスポンスするが，レスポンスボディがok: falseとなっており，error項目でエラー内容をレスポンスする"というようなことは行わない．
  - 結果的にいわゆるResult型のパターンを採用するメリットに乏しいことから，Result型形式のレスポンスは行わない．
- **必要十分なデータを渡す**
  - 正常応答時には，必要最小限の項目をレスポンスすることを心がける．
    - バックエンドにおいて必要な項目でも，フロントエンドレイヤでは必要がないこともある（例：ownerUserId）
  - エラー応答時には，以下が明らかになるような情報をレスポンスする
    - エラーの原因
    - エラーを受け取ったクライアント・ユーザがすべき行動/アクション
      - （例）認証をやり直す
      - （例）バリデーションエラーを起こしている項目を修正してリトライ
      - （例）しばらく待ってリトライ

## ステータスコード別レスポンス形式標準

### Success Response(2xx)

- **200 OK**
  - 代表ケース
    - 他の2XXレスポンスに該当しない全ての正常系レスポンス
  - 業務要件により必要となるレスポンス形式は異なるため，ステータスコード別の標準としては定義しない．
  - オーバーフェッチを避け、フロントエンドで本当に必要な項目だけを含めるように留意すること．
- **201 Created**
  - 代表ケース
    - 新たな集約を作成した
    - 集約を構成する子エンティティを作成する専用APIにおいて，子エンティティを追加した（集約としては"更新"に該当するが作成と見做す）
      - この考え方については後述の"（参考）集約を構成する子エンティティを追加・削除するAPIの扱い"を参照すること．
  - Locationヘッダに「作成したリソースを取得するリクエストURL」を設定する．
    - DDDで集約の子にあたるエンティティを追加したときは，子を単体で取得するURLが存在する場合はそれを，そうでない場合は**集約を取得するリクエストURL**を設定する．
      DDDでは基本的にリソースへのアクセスは集約単位に行うため，後者が一般的である．
  - レスポンスボディには作成したリソースを設定する．
    - DDDで集約の子にあたるエンティティを追加したときは，追加した子エンティティをレスポンスボディに設定する(集約全体は設定しない)．
- **204 No Content**
  - 代表ケース
    - 集約を削除した
    - 集約を構成する子エンティティを削除する専用APIにおいて，子エンティティを削除した（集約としては"更新"に該当するが削除と見做す）
      - この考え方については後述の"（参考）集約を構成する子エンティティを追加・削除するAPIの扱い"を参照すること．
      -

### Error Responseのとき

エラーレスポンスにはClient Error Response（4XX）とServer Error Response（5xx）があるが，
そのどちらにおいても以下のスキーマをレスポンスボディに設定しレスポンスすることを原則とする．

```json
{
  "error": {
    "requestId": "req_abc123def456",
    "message": "入力データのフォーマットが不正です．入力値を修正して再度送信してください．",
    "details": [
      {
        "field": "email",
        "code": "INVALID_FORMAT",
        "message": "メールアドレスの形式が正しくありません"
      },
      {
        "field": "password",
        "code": "TOO_SHORT",
        "message": "パスワードは8文字以上である必要があります"
      }
    ],
  }
}
```

"error"配下の各項目はそれぞれ以下の情報を提供する．

| 項目名 | 必須 | 内容 |
| --- | --- | --- |
| requestId | * | サーバ側でリクエストを一意に特定する識別子．問い合わせ等の対応のために明記する． |
| message | * | エンドユーザに対して表示するメッセージ．事象と次に求められるアクションを明記する． |
| details |  | 400 Bad Requestのとき，その不正項目を示す配列．配列の各要素は「フィールド名(field)」「エラー種別(code)」「メッセージ(message)」を持つ． |

details配下のcodeは以下のENUMとする．

| コード | 説明 | 使用例 |
|--------|------|--------|
| `REQUIRED` | 必須フィールド未入力 | 全フィールド |
| `INVALID_FORMAT` | 形式不正 | email, phone等 |
| `TOO_SHORT` | 最小長未満 | password等 |
| `TOO_LONG` | 最大長超過 | 全文字列フィールド |
| `OUT_OF_RANGE` | 数値範囲外 | age, amount等 |
| `DUPLICATE` | 重複値 | email, username等 |
| `DOMAIN_RULE_VIOLATION` | ドメインルール違反 | Domain層でのエラー |

### Client Error Response(4xx)

- **400 Bad Request**
  - 代表ケース
    - リクエストがZodエラーとなるとき（外形的な精査）
    - 400との使い分け：構文エラー・Zodでエラーとできるものは400、ドメイン層で精査するものは429
- **401 Unauthorized**
  - 代表ケース
    - Authorizationヘッダが設定されていないとき
    - Authorizationヘッダに設定されたJWTのデコードに失敗したとき
- **403 Forbidden（※原則アプリレイヤでは使用しない）**
  - 代表ケース
    - WAF等により，アプリやリソースの状況を問わずリクエストをBLOCKする場合
  - 注意点
    - アプリレイヤにおいて，「リソースは存在するが他人のリソースなのでアクセスを認めない」という場合は，**403 Forbiddenではなく404 Not Foundを用いる．**
      これは，**ステータスコードの違いによって「そのIDのリソースが存在するかしないか判別できる」ことを避けるためである．**
- **404 Not Found**
  - 代表ケース
    - 指定されたリクエストURLが定義されていない場合
    - 指定されたリソースが存在しない場合
    - 指定されたリソースが存在するがリクエストしたユーザにアクセス権限が無い場合
      - 403 Forbiddenの注意点に記載した通りの考え方
- **422 Unprocessable Entity**
  - 代表ケース
    - リクエスト形式は正しいが、ビジネスルール違反時
    - 400との使い分け：構文エラー・Zodでエラーとできるものは400、ドメイン層で精査するものは429

### Server Error Response(4xx)

- **500 Internal Server Error**
  - 代表ケース
    - 予期しない状況に遭遇した時


# 補足情報

## （参考）集約を構成する子エンティティを追加・削除するAPIの扱い

集約を構成する子エンティティを「追加」する場合，集約が変更の単位と考えるDDDの文脈においては，それは「更新」となる．
この時，集約を構成するエンティティを「追加」したとき，200 OKを返すか，201 Createdを返すかは，以下の判断基準で決定する．

- **APIが「集約に対するPUT」として提供されている場合**
  - （例）PUT /api/aggregate/{aggregateId}
  - このAPIの場合は，更新の結果として子を「追加」していたとしても，APIの責務としては「更新」を担ったと扱い，200 OKをレスポンスする．
- **APIが「子エンティティに対するPOST」として提供されている場合**
  - （例）POST /api/aggregate/{aggregateId}/children
  - このAPIの場合は，APIとしてはchildrenの「追加」を担ったと扱い，201 Createdをレスポンスする．

集約の子を削除する場合も同様の考え方をとる（APIが「集約の更新」用のパスなら200を，「子の削除」用のパスなら204を，それぞれレスポンスする）．