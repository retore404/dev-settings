# **React Router v7におけるFeature-Sliced Design実装ガイドライン**

## このドキュメントについて

このドキュメントは，React Router v7を利用しているフロントエンドアプリケーションにおいて，Feature-Sliced Design(FSD)に従い設計・ディレクトリ構成するためのガイドラインである．
本アプリケーションのWEBフロントエンド開発では，**必ずこのガイドラインに従い設計・実装を行うこと．**

## FSDの目的

FSDは，アプリケーションを技術的な関心事（例：components）ではなく、ビジネス価値をもたらす機能（例：user-profile）を中心に構成する．
その目的は，ビジネス要件の変化に対応しやすく、理解と保守が容易な、安定したプロジェクト構造を構築するためである．

## FSDの基本概念（layer, slice, segmentの階層構造）

FSDの構造は"レイヤー(Layers)", "スライス(Slices)", "セグメント(Segment)"の3つ（またはアプリケーションの特性により"サブスライス（Sub-slices）"を含む4つ）の構成要素からなる(*)．
FSDのアーキテクチャは"レイヤー" -> "スライス" -> (サブスライスを使う場合は"サブスライス") -> "セグメント"という親子関係を持つ階層構造からなる．

* 「サブスライス」は本ガイドラインにおけるオリジナル概念であり，一般的なFSDには存在しないことに注意．

### レイヤー（Layers）

レイヤーは，FSDの最上位レベルの概念であり，コードの責任範囲と性質に基づいてアプリケーションを分割する．
各レイヤーは明確に定義された目的を持ち，プロジェクト全体で標準化される．

定義されるレイヤーとそれぞれの責務は以下の通りである．

| レイヤー | 目的・責務 | 主要な特徴 | スライス/モジュールの例 |
| :---- | :---- | :---- | :---- |
| app | アプリケーションの初期化、グローバルなコンテキスト、ルーティング。アプリケーションのエントリポイント。 | スライスを持たず、セグメントのみを含む。最上位レイヤーであり、他のすべてのレイヤーからインポート可能。 | app/providers, app/routes, app/styles |
| pages | ウィジェットやフィーチャーで構成される、完全なアプリケーションページ。 | 各ページが1つのスライスとなる。スライス同士は相互にインポートできない。 | pages/home, pages/product-details |
| widgets | 複数のページで再利用される可能性のある、自己完結した複合UIブロック。ビジネスロジックを含む。 | 複数のフィーチャーやエンティティを単一のユニットに組み合わせる。 | widgets/site-header, widgets/product-recommendations |
| features | ユーザーにビジネス価値をもたらすユーザーインタラクションロジック。単一の原子的アクション。 | 特定のビジネスロジック、そのUI、およびAPI呼び出しをカプセル化する。 | features/auth-by-email, features/onlinestore/add-to-cart |
| entities | アプリケーションの中核となるビジネスエンティティ。ドメインの「名詞」。 | データ、エンティティ関連のビジネスロジック、およびUI表現を含む。 | entities/user, entities/product, entities/order |
| shared | アプリケーション固有のロジックから独立した、再利用可能なコード（UIキット、ヘルパー、設定など）。 | スライスを持たず、セグメントのみを含む。最下位レイヤーであり、他のどのレイヤーからもインポートできない。 | shared/ui, shared/api, shared/lib, shared/config |


#### features, entities, widgets の区別

これら3つのレイヤーはしばしば混乱を招くため，その違いを明確に定義する．。

* **Entity（エンティティ）**: ドメインの中核となるビジネスオブジェクト（例：Product）．データとそのUI表現（例：ProductCard）を持ちます。
* **Feature（フィーチャー）**: ユーザーがエンティティに対して，またはエンティティを用いて実行できるアクション（例：addToCart, toggleFavorite）．そのインタラクションのためのロジックをカプセル化します。
* **Widget（ウィジェット）**: エンティティとフィーチャーを組み合わせて構成される，より大きな独立したUIブロック（例：複数のProductCardエンティティを表示し、それぞれにaddToCartフィーチャーを持つRecommendationsFeedウィジェット）。

### スライス（Slices）

スライスは，特定のレイヤー内に配置されるサブディレクトリであり，ビジネスドメインや機能によってコードを分割する．
スライスの命名は，技術的な機能ではなく，ビジネス上の意味（例：user, post, order-processing）に基づいて決定される．
このアプローチにより，コードベースはビジネス要件と直接的に結びつき，論理的に関連するモジュールが物理的に近くに配置されるため，ナビゲーションが容易となる．

### サブスライス（Sub-slices）

サブスライスは，特定のスライス内に配置されるサブディレクトリであり，中規模以上のアプリケーションにおいてスライスが肥大化することを防ぐ目的でコードを分割する．
例えば，スライスとして「user」を定義したとき，「user」直下に「ユーザ登録」「ユーザ更新」「ユーザ情報照会」「ユーザ削除」……と多数のコードベースが展開されると，コードベースの把握が難しくなる．
これを防ぐため，例えば「user」直下に「user-register」をサブスライスとして定義し，「ユーザ登録」に関わるセグメント（後述）をここに配置する．
このように，「スライス」と「サブスライス」の利用により，技術的な機能ではなくビジネス上の意味でコードベースを分割しつつ，ドメイン・フィーチャーごとに存在する機能を把握しやすくなる．

### セグメント

セグメントは，スライスまたはサブスライス，例外的にappおよびsharedレイヤーにおいてはレイヤー内に配置されるディレクトリである．
セグメントは，コードをその「種類（what）」ではなく「技術的な目的（for what）」に基づいてグループ化する．
例えば、コンポーネントを格納するディレクトリはcomponentsではなくui，状態管理ロジックを格納するディレクトリはstoreやhooksではなくmodelと命名する．
これにより、コードの意図が明確になり、凝集度が高まる．

以下のようなセグメントを定義する．

| セグメント | 目的・責務 | ファイルタイプの例 |
| :---- | :---- | :---- |
| ui | UIコンポーネント、レイアウト、スタイルなど、すべてのプレゼンテーション関連コード。 | .tsx, .vue, .svelte, .css, .scss |
| model | ビジネスロジック、状態管理、データ操作。 | 状態管理スライス (Redux, Zustand)、セレクタ、ビジネスロジックを持つカスタムフック。 |
| api | 外部APIと対話するための関数。 | データ取得関数、APIクライアントインスタンス、リクエスト/レスポンスの型定義。 |
| lib | スライス固有の補助的なヘルパー関数やユーティリティ。 | フォーマッタ、バリデータ、ユーティリティ関数。 |
| config | スライス用の設定定数やセッティング。 | フィーチャーフラグ、環境固有の変数。 |

## 依存関係のルール

### レイヤー間の依存関係ルール

上位レイヤーからのみ下位レイヤーに依存可．逆依存は禁止．

| Layer      | 依存可能なレイヤー                                     |
| ---------- | ---------------------------------------------------- |
| `app`      | `pages`, `widgets`, `features`, `entities`, `shared` |
| `pages`    | `widgets`, `features`, `entities`, `shared`          |
| `widgets`  | `features`, `entities`, `shared`                     |
| `features` | `entities`, `shared`                                 |
| `entities` | `shared`                                             |
| `shared`   | （他レイヤーに依存禁止）                               |

### スライス・サブスライス分離の原則

「同じレイヤーに属するスライスまたはサブスライス同士は，互いに依存してはならない」．
例えば，pages/homeスライスがpages/profileスライスから何かをインポートすることは禁止される．
同様に，features/auth-by-emailスライスがfeatures/add-to-cartスライスからインポートすることもできない．

この原則は，「高凝集・低結合」というソフトウェア設計の理想を強制する．
各スライスは自己完結したビジネス機能の単位となり，他の部分への副作用を最小限に抑えながら，開発，テスト，削除が可能になる．
もし複数のスライスでロジックを共有する必要が生じた場合は，その共有ロジックを明示的に抽出し，より下位のレイヤー（通常はfeatures，entities，またはshared）に配置する必要がある．

## Public APIルール（公開エントリーポイント）

- 各スライスは index.ts によって公開するものを明示する（index.tsは明示的な名前付き再エクスポートを使用し公開する）．
- 外部からの参照はすべて index.ts 経由で行う．
- 内部構造は外部に漏らさず、スライスの独立性を保つ．

```
// NG: 内部ファイルを直接参照（依存方向の漏れが起きやすい）
import { useUserApi } from 'entities/User/model/useUserApi';

// OK: Public API からの参照
import { useUserData } from 'entities/User';
```

## React Router v7 with Feature-Sliced Design

### React Router v7を利用するアプリケーションにおいてFSDを採用した場合のディレクトリ構成サンプル

以下に、典型的なReact Router v7を利用するアプリにおけるFSDのディレクトリ構造を示す．

app/
├── root.tsx            \# **ファイルの性質上，appレイヤーに属すべきだがFWのデファクトスタンダードとしてルートディレクトリ直下に配置する**
├── routes.ts           \# **ファイルの性質上，appレイヤーに属すべきだがFWのデファクトスタンダードとしてルートディレクトリ直下に配置する**
├── app/
│   ├── routes/         \# React Router v7のルート定義（例：spot.$spotId.detail.tsx）
│   ├── styles/         \# グローバルなスタイルシート
│   └── index.ts        \# appレイヤのエントリポイント
├── pages/
│   ├── spots/          \# ビジネス的な意味をもつ"Spots"のスライス
│   │   ├── index.ts    \# Public API
│   │   ├── register/   \# （サブスライスを定義する場合）"Spots"のうち登録機能を意味するサブスライス
│   │   │   ├── ui/     \# スポット登録ページを構成するUIコンポーネント
│   │   │   └── model/  \# スポット登録ページのビジネスロジック
│   │   └── update/     \# （サブスライスを定義する場合）"Spots"のうち更新機能を意味するサブスライス
│   │       ├── ui/     \# スポット更新ページを構成するUIコンポーネント
│   │       └── model/  \# スポット更新ページのビジネスロジック
│   ├── trip-plan/      \# ビジネス的な意味をもつ"TripPlan"のスライス
│   │   ├── ui/         \# 旅行計画ページを構成するUIコンポーネント
│   │   ├── model/      \# 旅行計画ページ固有のビジネスロジック
│   │   └── index.ts    \# Public API
│   └── other-business-concept/
│       └──...
├── widgets/
│   ├── site-header/
│   │   ├── ui/         \# サイトヘッダーのUI
│   │   └──...
│   └── dashboards/
│       └──...
├── features/
│   ├── spots/          \# Spots"に関するfeatureを集約するスライス
│   │   ├── index.ts    \# Public API
│   │   ├── register/   \# （サブスライスを定義する場合）"Spots"のうち登録機能を集約するサブスライス
│   │   │   ├── ui/     \# スポット登録機能を構成するUIコンポーネント
│   │   │   ├── api/    \# スポット登録機能特有のAPIの定義（シンプルなCURDはentitiesレイヤで定義）
│   │   │   └── model/  \# スポット登録機能のビジネスロジック
│   │   └── search/     \# （サブスライスを定義する場合）"Spots"のうち検索機能を集約するサブスライス
│   │       ├── ui/     \# スポット検索機能を構成するUIコンポーネント
│   │       ├── api/    \# スポット検索機能特有のAPIの定義（シンプルなCURDはentitiesレイヤで定義）
│   │       └── model/  \# スポット検索機能のビジネスロジック
│   └── trip-plan/
│       └──...
├── entities/
│   ├── spots/
│   │   ├── api/        \# entitiesをCRUDするシンプルなAPIの定義
│   │   ├── ui/         \# Spot情報を表示するコンポーネント
│   │   ├── model/      \# ユーザーストア、型定義
│   │   └── index.ts    \# Public API
│   └── trip/
│       └──...
└── shared/
    ├── ui/
    │   ├── button/
    │   │   └── index.ts
    │   └── input/
    │       └── index.ts
    ├── api/
    │   └── index.ts
    ├── lib/
    │   └── index.ts
    └── config/
        └── index.ts
